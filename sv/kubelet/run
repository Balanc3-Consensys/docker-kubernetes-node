#!/bin/bash

source /etc/envvars

export IP=`ip route get 1 | awk '{print $NF;exit}'`
HOST=`hostname -s`
KUBELET_OPTS="--address=0.0.0.0 \
--hostname_override=$IP \
--cluster_dns=$IP \
--port=10250 \
--api_servers=$KUBERNETES_MASTER \
--containerized=false \
--image-gc-high-threshold=50 \
--image-gc-low-threshold=30 \
--registry-qps=0 \
--hairpin-mode=hairpin-veth \
--serialize-image-pulls=false \
--node-labels=host=${HOST},${LABELS} \
--allow-privileged=true \
--pod-manifest-path=/etc/kubernetes/manifests \
--network-plugin=cni \
--cni-conf-dir=/etc/cni/net.d \
--cni-bin-dir=/opt/cni/bin \
--v=2 \
--logtostderr=true"

mkdir -p /etc/cni/net.d
envsubst < /calico/10-calico.conflist > /etc/cni/net.d/10-calico.conflist
envsubst < /calico/calico-node.yaml > /etc/kubernetes/manifests/calico-node.yaml

exec 2>&1
exec kubelet ${KUBELET_OPTS}
