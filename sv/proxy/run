#!/bin/bash

source /etc/envvars

IP=`ip route get 1 | awk '{print $NF;exit}'`
KUBE_PROXY_OPTS="\
--cluster-cidr "$CLUSTER_CIDR" \
--hostname-override=$IP \
--proxy-mode=iptables \
--v=2 \
--kubeconfig=/etc/kubernetes/proxy-kubeconfig.yml \
--logtostderr=true"

mkdir -p /etc/kubernetes
cat /etc/template/kubeconfig.yml | envsubst > /etc/kubernetes/proxy-kubeconfig.yml

exec 2>&1
exec kube-proxy ${KUBE_PROXY_OPTS}
